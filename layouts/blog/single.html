{{ define "title" }}{{ .Title }} &mdash; {{ .Site.Title }}{{ end }}
{{ define "meta_description" }}{{ .Description | default .Site.Params.description }}{{ end }}
{{ define "og_title" }}{{ .Title }}{{ end }}
{{ define "og_description" }}{{ .Description | default .Site.Params.description }}{{ end }}
{{ define "og_type" }}article{{ end }}
{{ define "og_image" }}{{ with .Resources.GetMatch "artwork.*" }}{{ (.Fill "1200x630 jpg q85").Permalink }}{{ else }}{{- $fallback := resources.Get (printf "s/img/%s" .Site.Params.photo) -}}{{ $fallback.Permalink }}?v={{ $fallback.Content | md5 }}{{ end }}{{ end }}

{{ define "extra_meta" }}
  <meta property="article:published_time" content="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
  {{- with .Params.updated }}
  <meta property="article:modified_time" content="{{ time.AsTime . | time.Format "2006-01-02T15:04:05Z07:00" }}">
  {{- end }}
  <meta property="article:author" content="{{ .Site.Title }}">
  {{- range .GetTerms "tags" }}
  <meta property="article:tag" content="{{ .LinkTitle }}">
  {{- end }}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": {{ .Title | jsonify | safeJS }},
    "datePublished": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}",
    {{- with .Params.updated }}
    "dateModified": "{{ time.AsTime . | time.Format "2006-01-02T15:04:05Z07:00" }}",
    {{- end }}
    "author": { "@id": "{{ $.Site.BaseURL }}#person" },
    "publisher": { "@id": "{{ $.Site.BaseURL }}#person" },
    {{- with .Description }}
    "description": {{ . | jsonify | safeJS }},
    {{- end }}
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": {{ replace .Permalink "/index.html" "/" | jsonify | safeJS }}
    },
    "isPartOf": { "@id": "{{ "blog/" | absURL }}#blog" }
    {{- with $.Resources.GetMatch "artwork.*" -}}
    ,
    "image": {
      "@type": "ImageObject",
      "url": {{ (.Fill "1200x630 jpg q85").Permalink | jsonify | safeJS }},
      "width": 1200,
      "height": 630
    }
    {{- end }}
    {{- with $.GetTerms "tags" -}}
    ,
    "keywords": [
      {{- range $i, $tag := . }}{{ if $i }},{{ end }}
      {{ $tag.LinkTitle | jsonify | safeJS }}
      {{- end }}
    ]
    {{- end }}
  }
  </script>
{{ end }}

{{ define "content" }}
{{ $artwork := .Resources.GetMatch "artwork.*" }}
{{ with $artwork }}
{{- $sm := .Fill "800x400 webp q80" -}}
{{- $md := .Fill "1200x600 webp q80" -}}
{{- $lg := .Fill "1600x800 webp q80" -}}
<!-- Hero with Artwork -->
<div class="relative w-full mb-10 border border-neutral-200 dark:border-neutral-700 overflow-hidden">
  <img
    src="{{ $md.RelPermalink }}"
    srcset="{{ $sm.RelPermalink }} 800w, {{ $md.RelPermalink }} 1200w, {{ $lg.RelPermalink }} 1600w"
    sizes="(max-width: 768px) 100vw, 672px"
    width="{{ $md.Width }}"
    height="{{ $md.Height }}"
    alt=""
    fetchpriority="high"
    class="w-full aspect-[2/1] object-cover">
  <div class="absolute inset-0 bg-gradient-to-t from-neutral-900/80 to-transparent"></div>
  <div class="absolute bottom-0 left-0 right-0 p-5 md:p-8">
    <p class="font-mono text-xs text-neutral-300 mb-3">
      <span class="bg-neutral-900/70 px-2 py-1">{{ time.Format ":date_medium" $.Date }}{{ with $.Params.updated }} &middot; {{ T "updated" }} {{ time.Format ":date_medium" . }}{{ end }}</span>
    </p>
    <h1 class="font-mono text-xl md:text-3xl font-bold text-white leading-tight">
      <span class="bg-neutral-900/70 decoration-clone box-decoration-clone px-2 py-1">{{ $.Title }}</span>
    </h1>
  </div>
</div>
{{ else }}
<!-- Header without Artwork -->
<header class="mb-8">
  <p class="font-mono text-xs text-neutral-400 dark:text-neutral-500 mb-3">
    {{ time.Format ":date_medium" .Date }}{{ with .Params.updated }} &middot; {{ T "updated" }} {{ time.Format ":date_medium" . }}{{ end }}
  </p>
  <h1 class="font-mono text-2xl md:text-3xl font-bold text-neutral-900 dark:text-neutral-100 leading-tight mb-6">{{ .Title }}</h1>
</header>
{{ end }}

{{ with .Description }}
<!-- Lead -->
<p class="text-base md:text-lg font-medium text-neutral-700 dark:text-neutral-300 leading-relaxed mb-10">
  {{ . }}
</p>
{{ end }}

<!-- Article with Share Sidebar -->
<div class="relative">
  <!-- Share Sidebar (desktop) -->
  <div class="hidden lg:block absolute -right-14 top-0 h-full">
    <div class="sticky top-24">
      {{ partial "share-buttons.html" (dict "page" . "style" "sidebar") }}
    </div>
  </div>

  <!-- Article Body -->
  <article class="text-sm md:text-base leading-[1.8] text-neutral-600 dark:text-neutral-400 space-y-6">
    {{ .Content }}
  </article>
</div>

<!-- Share Inline (end of article) -->
{{ partial "share-buttons.html" (dict "page" . "style" "inline") }}

<!-- Tags -->
{{ with .GetTerms "tags" }}
<div class="mt-10 flex flex-wrap gap-2">
  {{ range . }}
  <a href="{{ .RelPermalink }}" class="font-mono text-xs text-neutral-400 dark:text-neutral-500 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 hover:text-neutral-600 dark:hover:text-neutral-300 px-2 py-1 transition-colors">{{ .LinkTitle }}</a>
  {{ end }}
</div>
{{ end }}

<!-- Post Navigation -->
<nav class="mt-14 pt-6 border-t border-neutral-200 dark:border-neutral-700 flex items-baseline justify-between gap-4">
  <div>
    {{ with .NextInSection }}
    <a href="{{ .RelPermalink }}" class="font-mono text-sm text-accent hover:underline">&larr; {{ .Title | truncate 30 }}</a>
    {{ else }}
    <a href="/blog/" class="font-mono text-sm text-accent hover:underline">&larr; {{ T "back_to_blog" }}</a>
    {{ end }}
  </div>
  <div class="text-right">
    {{ with .PrevInSection }}
    <a href="{{ .RelPermalink }}" class="font-mono text-sm text-accent hover:underline">{{ .Title | truncate 30 }} &rarr;</a>
    {{ end }}
  </div>
</nav>

<!-- Share FAB (mobile) -->
{{ partial "share-buttons.html" (dict "page" . "style" "fab") }}
{{ end }}
